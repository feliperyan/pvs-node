<!DOCTYPE html>
<html lang="en">
<head>
  <% include ../partials/header.ejs %>
</head>

<body>
  <div id="dropZone" style="margin:0px auto;text-align:center;">
    <form action="/file-upload"
          class="dropzone"
          id="metamindUpload">
          <div class="dz-message">Drop image here or tap to upload</div>
    </form>
    <img id="einstein" src="/static/EinsteinAtom.png"/>
    <div class="fileupload-process">
      <div id="total-progress" class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="progress-bar progress-bar-success" style="width:0%;" data-dz-uploadprogress=""></div>
      </div>
    </div>
  </div>
  <div style="max-width:800px;margin:auto;">
    <% include ../partials/preview.ejs %>
  </div>
  <script>
    var previewNode = document.querySelector("#template");
    previewNode.id = "";
    var previewTemplate = previewNode.parentNode.innerHTML;
    previewNode.parentNode.removeChild(previewNode);

    Dropzone.options.metamindUpload = {
        uploadMultiple:false,
        acceptedFiles:".png,.jpg,.jpeg,.pgm",
        previewTemplate: previewTemplate,
        previewsContainer: "#previews",
        thumbnailWidth: null,
        thumbnailHeight: null,
        init: function() {
          this.on("sending", function(file) { 
            this.removeAllFiles();
            document.querySelector("#total-progress").style.opacity = "1";
            $("#metamindUpload").addClass("scale-down")
          });
          this.on("uploadprogress", function(file,progress,bytesSent) { 
            document.querySelector("#total-progress .progress-bar").style.width = progress + "%";
          });
          this.on("success", function(file, response) { 
            document.querySelector("#total-progress").style.opacity = "0"; 
            var jsonobj = JSON.parse(response);
            parseJSON(jsonobj);
          });
          this.on("error", function(file, error) { 
            document.querySelector("#total-progress").style.opacity = "0"; 
            console.error(error);
          });
          this.on("canceled", function(file) { 
            document.querySelector("#total-progress").style.opacity = "0"; 
            console.log("Canceled upload");
          });
        }
      }
      
      Dropzone.totaluploadprogress = function(progress) {
        document.querySelector("#total-progress .progress-bar").style.width = progress + "%";
      }

      function parseJSON(data){
        const table = document.getElementById("MetamindResults");
        var row,cell1,cell2;
        data.probabilities.forEach(function(e){
          row   = table.insertRow();
          cell1 = row.insertCell(0);
          cell2 = row.insertCell(1);
          cell1.innerHTML = e.label;
          cell2.innerHTML = e.probability;
        });
      }
  </script>
</body>
</html>
